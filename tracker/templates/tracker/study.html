{% extends 'tracker/dashboard_base.html' %}

{% block title %}Ders Ã‡alÄ±ÅŸ - Studie{% endblock %}

{% block page_title %}Ders Ã‡alÄ±ÅŸ{% endblock %}

{% block content %}
<style>
    /* Ana container */
    .study-container {
        max-width: 800px;
        margin: 0 auto;
        text-align: center;
    }
    
    /* Mod seÃ§im butonlarÄ± */
    .mode-selector {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-bottom: 30px;
    }
    
    .mode-btn {
        padding: 10px 20px;
        border: 2px solid #667eea;
        background-color: white;
        color: #667eea;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .mode-btn:hover {
        background-color: #f0f4ff;
    }
    
    .mode-btn.active {
        background-color: #667eea;
        color: white;
    }
    
    /* Timer container */
    .timer-container {
        background-color: white;
        border-radius: 15px;
        padding: 60px 40px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        min-height: 400px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    /* SÃ¼re gÃ¶sterimi */
    .timer-display {
        font-size: 72px;
        font-weight: 300;
        color: #333;
        margin-bottom: 40px;
        font-family: 'Courier New', monospace;
        letter-spacing: 2px;
    }
    
    /* Geri sayÄ±m gÃ¶sterimi iÃ§in margin */
    #countdownDisplay {
        margin-bottom: 30px;
        margin-top: 0;
    }
    
    /* Geri sayÄ±m iÃ§in input */
    .countdown-input-container {
        margin-bottom: 30px;
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 20px;
    }
    
    .countdown-input-wrapper {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .countdown-input {
        font-size: 36px;
        padding: 12px 18px;
        border: 3px solid #e0e0e0;
        border-radius: 12px;
        text-align: center;
        width: 115px;
        font-weight: 400;
        color: #333;
        transition: all 0.3s ease;
        background-color: #fafafa;
    }
    
    .countdown-input:focus {
        outline: none;
        border-color: #667eea;
        background-color: white;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    .countdown-input:disabled {
        background-color: #f5f5f5;
        cursor: not-allowed;
        opacity: 0.7;
    }
    
    .countdown-label {
        font-size: 18px;
        color: #666;
        font-weight: 500;
        letter-spacing: 0.5px;
    }
    
    /* Butonlar */
    .timer-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .control-btn {
        padding: 15px 35px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
    }
    
    /* Disabled class ile gÃ¶rsel durum - butonlar her zaman tÄ±klanabilir ama gÃ¶rsel olarak disabled gÃ¶rÃ¼nÃ¼r */
    .control-btn.btn-disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* Disabled class olan butonlarda hover efektleri Ã§alÄ±ÅŸsÄ±n ama tÄ±klama iÅŸe yaramaz */
    .control-btn.btn-disabled:hover {
        opacity: 0.6;
    }
    
    .btn-start {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-start:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-pause {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .btn-pause:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
    }
    
    .btn-reset {
        background-color: #e0e0e0;
        color: #333;
    }
    
    .btn-reset:hover {
        background-color: #d0d0d0;
        transform: translateY(-2px);
    }
    
    
    /* Gizli mod */
    .hidden {
        display: none;
    }
    
    /* Ã‡alÄ±ÅŸmalarÄ±ma ekle butonu */
    .btn-add-to-sessions {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 15px 35px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
        margin-top: 10px;
    }
    
    .btn-add-to-sessions:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
        background: linear-gradient(135deg, #5fb8ff 0%, #1affff 100%);
    }
    
    .btn-add-to-sessions:disabled {
        background: linear-gradient(135deg, #b0b0b0 0%, #8a8a8a 100%);
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Modal stili */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        overflow: auto;
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
    }
    
    @keyframes modalSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 25px;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }
    
    .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        transition: opacity 0.2s;
    }
    
    .close:hover {
        opacity: 0.7;
    }
    
    .modal-body {
        padding: 25px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
        box-sizing: border-box;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        width: 100%;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
</style>

<div class="study-container">
    <!-- Mod seÃ§im butonlarÄ± -->
    <div class="mode-selector">
        <button class="mode-btn active" id="stopwatchBtn" onclick="switchMode('stopwatch')">SÃ¼re Tutucu</button>
        <button class="mode-btn" id="countdownBtn" onclick="switchMode('countdown')">Geri SayÄ±m</button>
    </div>
    
    <!-- Timer container -->
    <div class="timer-container">
        <!-- SÃ¼re Tutucu Modu -->
        <div id="stopwatchMode">
            <div class="timer-display" id="stopwatchDisplay">00:00:00</div>
            <div class="timer-controls">
                <button class="control-btn btn-start" id="startBtn" onclick="startStopwatch()">BaÅŸlat</button>
                <button class="control-btn btn-pause" id="pauseBtn" onclick="pauseStopwatch()">Durdur</button>
                <button class="control-btn btn-reset" id="resetBtn" onclick="resetStopwatch()">SÄ±fÄ±rla</button>
            </div>
            <div style="display: flex; justify-content: center; margin-top: 15px;">
                <button class="btn-add-to-sessions" id="addToSessionsBtn" onclick="openAddSessionModal()" disabled>Ã‡alÄ±ÅŸmalarÄ±ma Ekle</button>
            </div>
        </div>
        
        <!-- Geri SayÄ±m Modu -->
        <div id="countdownMode" class="hidden">
            <div class="countdown-input-container">
                <div class="countdown-input-wrapper">
                    <input type="number" 
                           class="countdown-input" 
                           id="hoursInput" 
                           min="0" 
                           max="23" 
                           value="0" 
                           placeholder="0">
                    <span class="countdown-label">Saat</span>
                </div>
                <div class="countdown-input-wrapper">
                    <input type="number" 
                           class="countdown-input" 
                           id="minutesInput" 
                           min="0" 
                           max="59" 
                           value="25" 
                           placeholder="0">
                    <span class="countdown-label">Dakika</span>
                </div>
            </div>
            <div class="timer-display" id="countdownDisplay">25 dakika</div>
            <div class="timer-controls">
                <button class="control-btn btn-start" id="countdownStartBtn" onclick="startCountdown()">BaÅŸlat</button>
                <button class="control-btn btn-pause btn-disabled" id="countdownPauseBtn" onclick="pauseCountdown()">Durdur</button>
                <button class="control-btn btn-reset btn-disabled" id="countdownResetBtn" onclick="resetCountdown()">SÄ±fÄ±rla</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal - Geri SayÄ±m TamamlandÄ± -->
<div id="countdownCompleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Tebrikler! ðŸŽ‰</h3>
            <span class="close" onclick="closeCountdownCompleteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p id="countdownCompleteMessage" style="font-size: 16px; color: #555; margin-bottom: 25px; text-align: center; line-height: 1.6;"></p>
            <button type="button" class="btn-primary" onclick="openAddSessionFromCountdown()">Ã‡alÄ±ÅŸmalarÄ±ma Ekle</button>
        </div>
    </div>
</div>

<!-- Modal - Ã‡alÄ±ÅŸma KaydÄ± Ekle -->
<div id="addSessionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Ã‡alÄ±ÅŸma KaydÄ± Ekle</h3>
            <span class="close" onclick="closeAddSessionModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form method="post" id="sessionForm">
                {% csrf_token %}
                <input type="hidden" name="add_session" value="1">
                
                <div class="form-group">
                    <label for="{{ form.subject.id_for_label }}">{{ form.subject.label }}</label>
                    {{ form.subject }}
                    {% if form.subject.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 5px;">
                            {{ form.subject.errors }}
                        </div>
                    {% endif %}
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.duration.id_for_label }}">{{ form.duration.label }}</label>
                        <input type="number" 
                               class="form-control" 
                               id="id_duration" 
                               name="duration" 
                               min="1" 
                               required
                               readonly>
                        {% if form.duration.errors %}
                            <div style="color: #dc3545; font-size: 12px; margin-top: 5px;">
                                {{ form.duration.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_date">{{ form.date.label }}</label>
                        <input type="date" 
                               class="form-control" 
                               id="id_date" 
                               name="date" 
                               required>
                        {% if form.date.errors %}
                            <div style="color: #dc3545; font-size: 12px; margin-top: 5px;">
                                {{ form.date.errors }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.note.id_for_label }}">{{ form.note.label }}</label>
                    {{ form.note }}
                    {% if form.note.errors %}
                        <div style="color: #dc3545; font-size: 12px; margin-top: 5px;">
                            {{ form.note.errors }}
                        </div>
                    {% endif %}
                </div>
                
                <button type="submit" class="btn-primary">Dersi Kaydet</button>
            </form>
        </div>
    </div>
</div>

<script>
    // SÃ¼re tutucu deÄŸiÅŸkenleri
    let stopwatchInterval = null;
    let stopwatchSeconds = 0;
    let stopwatchRunning = false;
    let stopwatchStartTime = 0; // Timer baÅŸladÄ±ÄŸÄ±nda kaydedilen zaman
    let stopwatchPausedTime = 0; // DuraklatÄ±ldÄ±ÄŸÄ±nda toplam geÃ§en sÃ¼re
    
    // Geri sayÄ±m deÄŸiÅŸkenleri
    let countdownInterval = null;
    let countdownSeconds = 0;
    let countdownRunning = false;
    let originalHours = 0;
    let originalMinutes = 25;
    let countdownEndTime = 0; // Geri sayÄ±mÄ±n biteceÄŸi zaman
    let completedCountdownMinutes = 0; // Tamamlanan geri sayÄ±m dakikasÄ± (toplam dakika olarak)
    
    // Mod deÄŸiÅŸtirme fonksiyonu
    function switchMode(mode) {
        const stopwatchMode = document.getElementById('stopwatchMode');
        const countdownMode = document.getElementById('countdownMode');
        const stopwatchBtn = document.getElementById('stopwatchBtn');
        const countdownBtn = document.getElementById('countdownBtn');
        
        if (mode === 'stopwatch') {
            // SÃ¼re tutucu moduna geÃ§
            stopwatchMode.classList.remove('hidden');
            countdownMode.classList.add('hidden');
            stopwatchBtn.classList.add('active');
            countdownBtn.classList.remove('active');
            
            // Geri sayÄ±mÄ± durdur
            if (countdownRunning) {
                pauseCountdown();
            }
        } else {
            // Geri sayÄ±m moduna geÃ§
            stopwatchMode.classList.add('hidden');
            countdownMode.classList.remove('hidden');
            stopwatchBtn.classList.remove('active');
            countdownBtn.classList.add('active');
            
            // SÃ¼re tutucuyu durdur
            if (stopwatchRunning) {
                pauseStopwatch();
            }
        }
    }
    
    // SÃ¼re tutucu fonksiyonlarÄ±
    // Buton durumlarÄ±nÄ± takip eden deÄŸiÅŸkenler
    let canStart = true;
    let canPause = false;
    let canReset = false;
    
    function startStopwatch() {
        // EÄŸer zaten Ã§alÄ±ÅŸÄ±yorsa veya baÅŸlatÄ±lamazsa iÅŸlem yapma
        if (stopwatchRunning || !canStart) {
            return;
        }
        stopwatchRunning = true;
        // BaÅŸlangÄ±Ã§ zamanÄ±nÄ± kaydet (duraklatÄ±lmÄ±ÅŸ sÃ¼reyi de hesaba kat)
        // Her baÅŸlatmada yeni bir baÅŸlangÄ±Ã§ zamanÄ± kaydedilir
        stopwatchStartTime = Date.now() - (stopwatchPausedTime * 1000);
        // localStorage'a kaydet
        localStorage.setItem('stopwatchRunning', 'true');
        localStorage.setItem('stopwatchStartTime', stopwatchStartTime.toString());
        localStorage.setItem('stopwatchPausedTime', '0');
        stopwatchInterval = setInterval(updateStopwatch, 100);
        canStart = false;
        canPause = true;
        canReset = true;
        updateButtonStates();
    }
    
    function pauseStopwatch() {
        // EÄŸer Ã§alÄ±ÅŸmÄ±yorsa veya durdurulamazsa iÅŸlem yapma
        if (!stopwatchRunning || !canPause) {
            return;
        }
        stopwatchRunning = false;
        clearInterval(stopwatchInterval);
        // DuraklatÄ±ldÄ±ÄŸÄ±nda toplam geÃ§en sÃ¼reyi kaydet
        stopwatchPausedTime = stopwatchSeconds;
        // localStorage'a kaydet
        localStorage.setItem('stopwatchRunning', 'false');
        localStorage.setItem('stopwatchPausedTime', stopwatchPausedTime.toString());
        canStart = true;
        canPause = false;
        updateButtonStates();
    }
    
    function resetStopwatch() {
        // EÄŸer sÄ±fÄ±rlanamazsa iÅŸlem yapma
        if (!canReset || stopwatchSeconds === 0) {
            return;
        }
        pauseStopwatch();
        stopwatchSeconds = 0;
        stopwatchPausedTime = 0;
        stopwatchStartTime = 0;
        // localStorage'Ä± temizle
        localStorage.removeItem('stopwatchRunning');
        localStorage.removeItem('stopwatchStartTime');
        localStorage.removeItem('stopwatchPausedTime');
        updateStopwatchDisplay();
        canStart = true;
        canPause = false;
        canReset = false;
        document.getElementById('addToSessionsBtn').disabled = true;
        updateButtonStates();
    }
    
    // Buton gÃ¶rsel durumlarÄ±nÄ± gÃ¼ncelle (disabled class ekle/kaldÄ±r)
    function updateButtonStates() {
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        
        if (canStart) {
            startBtn.classList.remove('btn-disabled');
        } else {
            startBtn.classList.add('btn-disabled');
        }
        
        if (canPause) {
            pauseBtn.classList.remove('btn-disabled');
        } else {
            pauseBtn.classList.add('btn-disabled');
        }
        
        if (canReset) {
            resetBtn.classList.remove('btn-disabled');
        } else {
            resetBtn.classList.add('btn-disabled');
        }
    }
    
    function updateStopwatch() {
        // Her zaman baÅŸlangÄ±Ã§ zamanÄ±na gÃ¶re hesapla (Date objesi kullanarak)
        // Bu sayede sayfa deÄŸiÅŸtiÄŸinde veya baÅŸka bir ÅŸey olduÄŸunda doÄŸru Ã§alÄ±ÅŸÄ±r
        const currentTime = Date.now();
        const elapsed = Math.floor((currentTime - stopwatchStartTime) / 1000);
        stopwatchSeconds = elapsed;
        updateStopwatchDisplay();
        
        // 1 dakika (60 saniye) geÃ§tikten sonra "Ã‡alÄ±ÅŸmalarÄ±ma Ekle" butonunu aktif et
        if (stopwatchSeconds >= 60) {
            document.getElementById('addToSessionsBtn').disabled = false;
        }
        
        // SÃ¼re 0'dan bÃ¼yÃ¼kse SÄ±fÄ±rla butonunu aktif et
        if (stopwatchSeconds > 0) {
            canReset = true;
            updateButtonStates();
        }
    }
    
    function updateStopwatchDisplay() {
        const hours = Math.floor(stopwatchSeconds / 3600);
        const minutes = Math.floor((stopwatchSeconds % 3600) / 60);
        const seconds = stopwatchSeconds % 60;
        
        const display = String(hours).padStart(2, '0') + ':' + 
                       String(minutes).padStart(2, '0') + ':' + 
                       String(seconds).padStart(2, '0');
        document.getElementById('stopwatchDisplay').textContent = display;
    }
    
    // Geri sayÄ±m fonksiyonlarÄ±
    // Geri sayÄ±m buton durumlarÄ±nÄ± takip eden deÄŸiÅŸkenler
    let canStartCountdown = true;
    let canPauseCountdown = false;
    let canResetCountdown = false;
    
    function startCountdown() {
        if (!countdownRunning && canStartCountdown) {
            const hoursInput = document.getElementById('hoursInput');
            const minutesInput = document.getElementById('minutesInput');
            const hours = parseInt(hoursInput.value) || 0;
            const minutes = parseInt(minutesInput.value) || 0;
            
            if (hours === 0 && minutes === 0) {
                alert('LÃ¼tfen geÃ§erli bir sÃ¼re girin (en az 1 dakika)');
                return;
            }
            
            // Ä°lk baÅŸlatmada saat ve dakika deÄŸerlerini kaydet
            if (countdownSeconds === 0) {
                originalHours = hours;
                originalMinutes = minutes;
                // Toplam dakikayÄ± hesapla (popup iÃ§in)
                completedCountdownMinutes = (hours * 60) + minutes;
                // Toplam saniyeyi hesapla
                countdownSeconds = (hours * 3600) + (minutes * 60);
            }
            
            // Her baÅŸlatmada yeni bir bitiÅŸ zamanÄ± hesapla (kalan sÃ¼reye gÃ¶re)
            // Bu sayede sayfa deÄŸiÅŸtiÄŸinde veya baÅŸka bir ÅŸey olduÄŸunda doÄŸru Ã§alÄ±ÅŸÄ±r
            countdownEndTime = Date.now() + (countdownSeconds * 1000);
            
            // localStorage'a kaydet
            localStorage.setItem('countdownRunning', 'true');
            localStorage.setItem('countdownEndTime', countdownEndTime.toString());
            localStorage.setItem('countdownOriginalHours', originalHours.toString());
            localStorage.setItem('countdownOriginalMinutes', originalMinutes.toString());
            
            countdownRunning = true;
            countdownInterval = setInterval(updateCountdown, 100);
            canStartCountdown = false;
            canPauseCountdown = true;
            canResetCountdown = true;
            updateCountdownButtonStates();
            hoursInput.disabled = true;
            minutesInput.disabled = true;
        }
    }
    
    function pauseCountdown() {
        if (countdownRunning && canPauseCountdown) {
            countdownRunning = false;
            clearInterval(countdownInterval);
            // DuraklatÄ±ldÄ±ÄŸÄ±nda kalan sÃ¼reyi hesapla ve kaydet
            // Bu sayede tekrar baÅŸlatÄ±ldÄ±ÄŸÄ±nda doÄŸru sÃ¼reyle devam eder
            const remaining = Math.max(0, Math.floor((countdownEndTime - Date.now()) / 1000));
            countdownSeconds = remaining;
            // localStorage'a kaydet
            localStorage.setItem('countdownRunning', 'false');
            localStorage.setItem('countdownRemainingSeconds', countdownSeconds.toString());
            canStartCountdown = true;
            canPauseCountdown = false;
            updateCountdownButtonStates();
            // Input'lar disabled kalÄ±r, sadece sÄ±fÄ±rla tuÅŸuna basÄ±ldÄ±ÄŸÄ±nda tekrar aktif olur
        }
    }
    
    function resetCountdown() {
        if (!canResetCountdown || countdownSeconds === 0) {
            return;
        }
        pauseCountdown();
        const hoursInput = document.getElementById('hoursInput');
        const minutesInput = document.getElementById('minutesInput');
        countdownSeconds = 0;
        countdownEndTime = 0;
        originalHours = parseInt(hoursInput.value) || 0;
        originalMinutes = parseInt(minutesInput.value) || 25;
        countdownSeconds = (originalHours * 3600) + (originalMinutes * 60);
        // localStorage'Ä± temizle
        localStorage.removeItem('countdownRunning');
        localStorage.removeItem('countdownEndTime');
        localStorage.removeItem('countdownRemainingSeconds');
        localStorage.removeItem('countdownOriginalHours');
        localStorage.removeItem('countdownOriginalMinutes');
        updateCountdownDisplay();
        canStartCountdown = true;
        canPauseCountdown = false;
        canResetCountdown = false;
        updateCountdownButtonStates();
        hoursInput.disabled = false;
        minutesInput.disabled = false;
    }
    
    // Geri sayÄ±m buton gÃ¶rsel durumlarÄ±nÄ± gÃ¼ncelle
    function updateCountdownButtonStates() {
        const startBtn = document.getElementById('countdownStartBtn');
        const pauseBtn = document.getElementById('countdownPauseBtn');
        const resetBtn = document.getElementById('countdownResetBtn');
        
        if (canStartCountdown) {
            startBtn.classList.remove('btn-disabled');
        } else {
            startBtn.classList.add('btn-disabled');
        }
        
        if (canPauseCountdown) {
            pauseBtn.classList.remove('btn-disabled');
        } else {
            pauseBtn.classList.add('btn-disabled');
        }
        
        if (canResetCountdown) {
            resetBtn.classList.remove('btn-disabled');
        } else {
            resetBtn.classList.add('btn-disabled');
        }
    }
    
    function updateCountdown() {
        // Her zaman bitiÅŸ zamanÄ±na gÃ¶re hesapla (Date objesi kullanarak)
        // Bu sayede sayfa deÄŸiÅŸtiÄŸinde veya baÅŸka bir ÅŸey olduÄŸunda doÄŸru Ã§alÄ±ÅŸÄ±r
        const currentTime = Date.now();
        const remaining = Math.max(0, Math.floor((countdownEndTime - currentTime) / 1000));
        countdownSeconds = remaining;
        updateCountdownDisplay();
        
        // SÃ¼re 0'dan bÃ¼yÃ¼kse SÄ±fÄ±rla butonunu aktif et
        if (countdownSeconds > 0) {
            canResetCountdown = true;
            updateCountdownButtonStates();
        }
        
        if (countdownSeconds <= 0) {
            // Geri sayÄ±m bitti
            pauseCountdown();
            // Tamamlanan dakika sayÄ±sÄ±nÄ± kaydet (resetCountdown'dan Ã¶nce)
            completedCountdownMinutes = (originalHours * 60) + originalMinutes;
            // localStorage'Ä± temizle
            localStorage.removeItem('countdownRunning');
            localStorage.removeItem('countdownEndTime');
            localStorage.removeItem('countdownRemainingSeconds');
            localStorage.removeItem('countdownOriginalHours');
            localStorage.removeItem('countdownOriginalMinutes');
            // Popup'Ä± gÃ¶ster
            showCountdownCompleteModal();
            // Geri sayÄ±mÄ± sÄ±fÄ±rla (resetCountdown originalHours ve originalMinutes'Ä± input'tan tekrar alacak)
            resetCountdown();
        }
    }
    
    function updateCountdownDisplay() {
        const totalMinutes = Math.floor(countdownSeconds / 60);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        const seconds = countdownSeconds % 60;
        
        // Saat:dakika:saniye formatÄ±nda gÃ¶ster (Ã¶r: 1:30:45, 0:25:30, 2:05:00)
        const display = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        document.getElementById('countdownDisplay').textContent = display;
    }
    
    // Sayfa yÃ¼klendiÄŸinde geri sayÄ±mÄ± baÅŸlat ve buton durumlarÄ±nÄ± ayarla
    window.addEventListener('DOMContentLoaded', function() {
        // SÃ¼re tutucu durumunu localStorage'dan geri yÃ¼kle
        const savedRunning = localStorage.getItem('stopwatchRunning');
        const savedStartTime = localStorage.getItem('stopwatchStartTime');
        const savedPausedTime = localStorage.getItem('stopwatchPausedTime');
        
        if (savedRunning === 'true' && savedStartTime) {
            // SÃ¼re tutucu Ã§alÄ±ÅŸÄ±yordu, devam ettir
            stopwatchRunning = true;
            stopwatchStartTime = parseInt(savedStartTime);
            stopwatchPausedTime = parseInt(savedPausedTime) || 0;
            // GeÃ§en sÃ¼reyi hesapla
            const elapsed = Math.floor((Date.now() - stopwatchStartTime) / 1000);
            stopwatchSeconds = elapsed;
            updateStopwatchDisplay();
            // Timer'Ä± baÅŸlat
            stopwatchInterval = setInterval(updateStopwatch, 100);
            canStart = false;
            canPause = true;
            canReset = true;
            // 1 dakika geÃ§tiyse "Ã‡alÄ±ÅŸmalarÄ±ma Ekle" butonunu aktif et
            if (stopwatchSeconds >= 60) {
                document.getElementById('addToSessionsBtn').disabled = false;
            }
            updateButtonStates();
        } else if (savedPausedTime) {
            // SÃ¼re tutucu duraklatÄ±lmÄ±ÅŸtÄ±
            stopwatchPausedTime = parseInt(savedPausedTime) || 0;
            stopwatchSeconds = stopwatchPausedTime;
            updateStopwatchDisplay();
            canStart = true;
            canPause = false;
            canReset = stopwatchPausedTime > 0;
            // 1 dakika geÃ§tiyse "Ã‡alÄ±ÅŸmalarÄ±ma Ekle" butonunu aktif et
            if (stopwatchSeconds >= 60) {
                document.getElementById('addToSessionsBtn').disabled = false;
            }
            updateButtonStates();
        } else {
            // BaÅŸlangÄ±Ã§ buton durumlarÄ±nÄ± ayarla (sÃ¼re tutucu)
            canStart = true;
            canPause = false;
            canReset = false;
            updateButtonStates();
        }
        
        // Geri sayÄ±m durumunu localStorage'dan geri yÃ¼kle
        const savedCountdownRunning = localStorage.getItem('countdownRunning');
        const savedCountdownEndTime = localStorage.getItem('countdownEndTime');
        const savedCountdownRemaining = localStorage.getItem('countdownRemainingSeconds');
        const savedOriginalHours = localStorage.getItem('countdownOriginalHours');
        const savedOriginalMinutes = localStorage.getItem('countdownOriginalMinutes');
        
        const hoursInput = document.getElementById('hoursInput');
        const minutesInput = document.getElementById('minutesInput');
        
        if (savedCountdownRunning === 'true' && savedCountdownEndTime) {
            // Geri sayÄ±m Ã§alÄ±ÅŸÄ±yordu, devam ettir
            countdownEndTime = parseInt(savedCountdownEndTime);
            originalHours = parseInt(savedOriginalHours) || 0;
            originalMinutes = parseInt(savedOriginalMinutes) || 25;
            completedCountdownMinutes = (originalHours * 60) + originalMinutes;
            
            // Kalan sÃ¼reyi hesapla
            const remaining = Math.max(0, Math.floor((countdownEndTime - Date.now()) / 1000));
            countdownSeconds = remaining;
            
            if (countdownSeconds <= 0) {
                // SÃ¼re dolmuÅŸ, popup gÃ¶ster ve sÄ±fÄ±rla
                completedCountdownMinutes = (originalHours * 60) + originalMinutes;
                showCountdownCompleteModal();
                countdownSeconds = 0;
                countdownEndTime = 0;
                localStorage.removeItem('countdownRunning');
                localStorage.removeItem('countdownEndTime');
                localStorage.removeItem('countdownRemainingSeconds');
                localStorage.removeItem('countdownOriginalHours');
                localStorage.removeItem('countdownOriginalMinutes');
                canStartCountdown = true;
                canPauseCountdown = false;
                canResetCountdown = false;
                hoursInput.disabled = false;
                minutesInput.disabled = false;
            } else {
                // Timer'Ä± devam ettir
                countdownRunning = true;
                countdownInterval = setInterval(updateCountdown, 100);
                canStartCountdown = false;
                canPauseCountdown = true;
                canResetCountdown = true;
                hoursInput.disabled = true;
                minutesInput.disabled = true;
            }
            updateCountdownDisplay();
            updateCountdownButtonStates();
        } else if (savedCountdownRemaining) {
            // Geri sayÄ±m duraklatÄ±lmÄ±ÅŸtÄ±
            countdownSeconds = parseInt(savedCountdownRemaining);
            originalHours = parseInt(savedOriginalHours) || 0;
            originalMinutes = parseInt(savedOriginalMinutes) || 25;
            completedCountdownMinutes = (originalHours * 60) + originalMinutes;
            updateCountdownDisplay();
            canStartCountdown = true;
            canPauseCountdown = false;
            canResetCountdown = countdownSeconds > 0;
            hoursInput.disabled = false;
            minutesInput.disabled = false;
            updateCountdownButtonStates();
        } else {
            // BaÅŸlangÄ±Ã§ durumu
            originalHours = parseInt(hoursInput.value) || 0;
            originalMinutes = parseInt(minutesInput.value) || 25;
            countdownSeconds = (originalHours * 3600) + (originalMinutes * 60);
            updateCountdownDisplay();
            // BaÅŸlangÄ±Ã§ buton durumlarÄ±nÄ± ayarla (geri sayÄ±m)
            canStartCountdown = true;
            canPauseCountdown = false;
            canResetCountdown = false;
            updateCountdownButtonStates();
        }
        
        // Input deÄŸeri deÄŸiÅŸtiÄŸinde timer'Ä± gÃ¼ncelle (geri sayÄ±m Ã§alÄ±ÅŸmÄ±yorsa)
        function updateCountdownFromInputs() {
            if (!countdownRunning) {
                const hours = parseInt(hoursInput.value) || 0;
                const minutes = parseInt(minutesInput.value) || 0;
                countdownSeconds = (hours * 3600) + (minutes * 60);
                updateCountdownDisplay();
            }
        }
        
        hoursInput.addEventListener('input', updateCountdownFromInputs);
        minutesInput.addEventListener('input', updateCountdownFromInputs);
    });
    
    // Ã‡alÄ±ÅŸma kaydÄ± ekleme modal fonksiyonlarÄ±
    function openAddSessionModal() {
        // SÃ¼re tutucudaki sÃ¼reyi dakikaya Ã§evir (saniye kÄ±smÄ±nÄ± at)
        const totalMinutes = Math.floor(stopwatchSeconds / 60);
        
        // Form alanlarÄ±nÄ± doldur
        document.getElementById('id_duration').value = totalMinutes;
        
        // BugÃ¼nÃ¼n tarihini ayarla
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('id_date').value = `${year}-${month}-${day}`;
        
        // Modal'Ä± aÃ§
        document.getElementById('addSessionModal').style.display = 'block';
    }
    
    function closeAddSessionModal() {
        document.getElementById('addSessionModal').style.display = 'none';
    }
    
    // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('addSessionModal');
        if (event.target == modal) {
            closeAddSessionModal();
        }
    });
    
    // ESC tuÅŸu ile modal'Ä± kapat
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeAddSessionModal();
            closeCountdownCompleteModal();
        }
    });
    
    // Geri sayÄ±m tamamlandÄ± popup fonksiyonlarÄ±
    function showCountdownCompleteModal() {
        const modal = document.getElementById('countdownCompleteModal');
        const message = document.getElementById('countdownCompleteMessage');
        
        // Saat ve dakika formatÄ±nda mesaj oluÅŸtur
        const hours = Math.floor(completedCountdownMinutes / 60);
        const minutes = completedCountdownMinutes % 60;
        let timeText = '';
        if (hours > 0 && minutes > 0) {
            timeText = `${hours} saat ${minutes} dakika`;
        } else if (hours > 0) {
            timeText = `${hours} saat`;
        } else {
            timeText = `${minutes} dakika`;
        }
        
        message.textContent = `Tebrikler ${timeText} Ã§alÄ±ÅŸtÄ±n! Bu sÃ¼reyi Ã§alÄ±ÅŸmalarÄ±na eklemek ister misin?`;
        modal.style.display = 'block';
    }
    
    function closeCountdownCompleteModal() {
        document.getElementById('countdownCompleteModal').style.display = 'none';
    }
    
    function openAddSessionFromCountdown() {
        // Geri sayÄ±m tamamlandÄ± popup'Ä±nÄ± kapat
        closeCountdownCompleteModal();
        
        // Form alanlarÄ±nÄ± doldur
        document.getElementById('id_duration').value = completedCountdownMinutes;
        
        // BugÃ¼nÃ¼n tarihini ayarla
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('id_date').value = `${year}-${month}-${day}`;
        
        // Ã‡alÄ±ÅŸma kaydÄ± ekleme modal'Ä±nÄ± aÃ§
        document.getElementById('addSessionModal').style.display = 'block';
    }
    
    // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat (geri sayÄ±m tamamlandÄ± popup iÃ§in)
    window.addEventListener('click', function(event) {
        const addModal = document.getElementById('addSessionModal');
        const countdownCompleteModal = document.getElementById('countdownCompleteModal');
        
        if (event.target == addModal) {
            closeAddSessionModal();
        }
        
        if (event.target == countdownCompleteModal) {
            closeCountdownCompleteModal();
        }
    });
    
    // Sayfa gÃ¶rÃ¼nÃ¼r olduÄŸunda timer'larÄ± gÃ¼ncelle
    // Bu sayede sayfa deÄŸiÅŸtiÄŸinde veya baÅŸka bir ÅŸey olduÄŸunda timer'lar doÄŸru Ã§alÄ±ÅŸÄ±r
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            // Sayfa gÃ¶rÃ¼nÃ¼r olduÄŸunda timer'larÄ± gÃ¼ncelle
            if (stopwatchRunning) {
                // SÃ¼re tutucu Ã§alÄ±ÅŸÄ±yorsa, baÅŸlangÄ±Ã§ zamanÄ±na gÃ¶re gÃ¼ncelle
                updateStopwatch();
            }
            if (countdownRunning) {
                // Geri sayÄ±m Ã§alÄ±ÅŸÄ±yorsa, bitiÅŸ zamanÄ±na gÃ¶re gÃ¼ncelle
                updateCountdown();
            }
        }
    });
    
    // Sayfa odaklandÄ±ÄŸÄ±nda da timer'larÄ± gÃ¼ncelle
    window.addEventListener('focus', function() {
        if (stopwatchRunning) {
            updateStopwatch();
        }
        if (countdownRunning) {
            updateCountdown();
        }
    });
</script>
{% endblock %}

